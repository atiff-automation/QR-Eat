<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reactive Token Refresh Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    h1 {
      color: #333;
      margin-top: 0;
    }
    button {
      background: #0070f3;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover {
      background: #0051cc;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .status {
      padding: 10px;
      border-radius: 5px;
      margin: 10px 0;
    }
    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }
    .warning {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
    .countdown {
      font-size: 24px;
      font-weight: bold;
      color: #0070f3;
    }
    pre {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 5px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>üîÑ Reactive Token Refresh Test</h1>
    <p>This page tests the reactive 401 token refresh functionality.</p>

    <div id="status"></div>

    <div>
      <button onclick="testLogin()">1. Login</button>
      <button onclick="startCountdown()" id="waitBtn" disabled>2. Wait for Expiration</button>
      <button onclick="testApiCall()" id="testBtn" disabled>3. Test API Call</button>
      <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <div id="countdown" class="countdown" style="margin: 20px 0;"></div>
  </div>

  <div class="card">
    <h2>üìã Console Logs</h2>
    <p>Open browser DevTools (F12) ‚Üí Console to see detailed logs</p>
    <div id="logs"></div>
  </div>

  <div class="card">
    <h2>üìö Expected Behavior</h2>
    <ol>
      <li><strong>Login</strong>: Should show token expires in ~5 minutes</li>
      <li><strong>Wait</strong>: Countdown for 5+ minutes until token expires</li>
      <li><strong>Test</strong>: Make API call ‚Üí Should trigger 401 ‚Üí Reactive refresh ‚Üí Retry succeeds</li>
    </ol>

    <h3>Expected Console Output:</h3>
    <pre>üîç ApiClient: Response not OK for /api/pos/orders/pending { status: 401 }
üîê ApiClient.isAuthEndpoint("/api/pos/orders/pending") = false
üîÑ ApiClient: 401 detected for /api/pos/orders/pending
üöÄ ApiClient: Triggering token refresh
üîÑ forceTokenRefresh: Called
‚úÖ forceTokenRefresh: Refresh completed successfully
‚úÖ ApiClient: Token refresh successful, retrying
‚úÖ ApiClient: Retry successful</pre>
  </div>

  <script>
    let tokenExpiresAt = null;
    let countdownInterval = null;

    function showStatus(message, type = 'info') {
      const status = document.getElementById('status');
      status.className = `status ${type}`;
      status.textContent = message;
    }

    function addLog(message, data = null) {
      const logs = document.getElementById('logs');
      const logEntry = document.createElement('div');
      logEntry.style.marginBottom = '10px';
      logEntry.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>: ${message}`;
      if (data) {
        logEntry.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      }
      logs.appendChild(logEntry);
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = '';
    }

    async function testLogin() {
      try {
        showStatus('üîê Logging in...', 'info');
        addLog('Attempting login...');

        const response = await fetch('/api/auth/rbac-login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: 'mario@marios-authentic.com',
            password: 'staff123'
          }),
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          tokenExpiresAt = new Date(data.tokenExpiration.accessToken);
          const expiresIn = Math.floor((tokenExpiresAt - new Date()) / 1000);

          showStatus(`‚úÖ Login successful! Token expires in ${Math.floor(expiresIn / 60)} minutes`, 'success');
          addLog('Login successful', {
            tokenExpiration: data.tokenExpiration,
            expiresInSeconds: expiresIn
          });

          document.getElementById('waitBtn').disabled = false;
        } else {
          showStatus(`‚ùå Login failed: ${data.error}`, 'error');
          addLog('Login failed', data);
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        addLog('Login error', { error: error.message });
      }
    }

    function startCountdown() {
      if (!tokenExpiresAt) {
        showStatus('‚ùå Please login first', 'error');
        return;
      }

      showStatus('‚è±Ô∏è Waiting for token to expire...', 'warning');
      addLog('Starting countdown to token expiration');

      const countdownEl = document.getElementById('countdown');

      if (countdownInterval) clearInterval(countdownInterval);

      countdownInterval = setInterval(() => {
        const now = new Date();
        const remaining = Math.floor((tokenExpiresAt - now) / 1000);

        if (remaining > 0) {
          const minutes = Math.floor(remaining / 60);
          const seconds = remaining % 60;
          countdownEl.textContent = `Token expires in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        } else {
          const expired = Math.abs(remaining);
          const minutes = Math.floor(expired / 60);
          const seconds = expired % 60;
          countdownEl.textContent = `Token expired ${minutes}:${seconds.toString().padStart(2, '0')} ago`;

          if (expired >= 10) {
            clearInterval(countdownInterval);
            showStatus('‚úÖ Token expired! Ready to test reactive refresh', 'success');
            document.getElementById('testBtn').disabled = false;
            addLog('Token has expired - ready for testing');
          }
        }
      }, 1000);
    }

    async function testApiCall() {
      try {
        showStatus('üß™ Making API call (should trigger 401 and reactive refresh)...', 'info');
        addLog('Making test API call to /api/pos/orders/pending');
        addLog('‚ö†Ô∏è Watch the browser console (F12) for detailed ApiClient logs!');

        const response = await fetch('/api/pos/orders/pending', {
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          showStatus('‚úÖ API call succeeded! (refresh worked)', 'success');
          addLog('API call successful - reactive refresh worked!', {
            status: response.status,
            ordersCount: Array.isArray(data.orders) ? data.orders.length : 'N/A'
          });
        } else {
          showStatus(`‚ö†Ô∏è API call failed: ${response.status} - ${data.error || 'Unknown error'}`, 'warning');
          addLog('API call failed', {
            status: response.status,
            error: data.error || data
          });
        }
      } catch (error) {
        showStatus(`‚ùå Error: ${error.message}`, 'error');
        addLog('API call error', { error: error.message });
      }
    }

    // Capture console logs
    const originalLog = console.log;
    console.log = function(...args) {
      originalLog.apply(console, args);

      // Capture ApiClient logs in the page
      const message = args.join(' ');
      if (message.includes('ApiClient') || message.includes('forceTokenRefresh')) {
        addLog(message);
      }
    };

    addLog('üöÄ Test page loaded - Ready to test reactive token refresh');
    addLog('üìñ Instructions: 1) Login ‚Üí 2) Wait for countdown ‚Üí 3) Test API call');
  </script>
</body>
</html>
