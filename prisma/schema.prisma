generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model PlatformAdmin {
  id                  String                 @id @default(uuid())
  email               String                 @unique
  passwordHash        String
  firstName           String
  lastName            String
  role                String                 @default("admin")
  isActive            Boolean                @default(true)
  lastLoginAt         DateTime?
  passwordChangedAt   DateTime               @default(now())
  failedLoginAttempts Int                    @default(0)
  lockedUntil         DateTime?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  auditLogs           AuditLog[]             @relation("AdminAuditLogs")
  processedPayments   Payment[]
  sessions            PlatformAdminSession[]
  refreshTokens       RefreshToken[]

  @@map("platform_admins")
}

model PlatformAdminSession {
  id             String        @id @default(uuid())
  adminId        String
  sessionToken   String        @unique
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime
  createdAt      DateTime      @default(now())
  lastActivityAt DateTime      @default(now())
  admin          PlatformAdmin @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@map("platform_admin_sessions")
}

model RestaurantOwner {
  id                     String                   @id @default(uuid())
  email                  String                   @unique
  passwordHash           String
  firstName              String
  lastName               String
  phone                  String?
  companyName            String?
  isActive               Boolean                  @default(true)
  lastLoginAt            DateTime?
  passwordChangedAt      DateTime                 @default(now())
  mustChangePassword     Boolean                  @default(false)
  failedLoginAttempts    Int                      @default(0)
  lockedUntil            DateTime?
  emailVerified          Boolean                  @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime                 @updatedAt
  auditLogs              AuditLog[]               @relation("OwnerAuditLogs")
  processedPayments      Payment[]
  refreshTokens          RefreshToken[]
  sessions               RestaurantOwnerSession[]
  restaurants            Restaurant[]

  @@map("restaurant_owners")
}

model RestaurantOwnerSession {
  id             String          @id @default(uuid())
  ownerId        String
  sessionToken   String          @unique
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime
  createdAt      DateTime        @default(now())
  lastActivityAt DateTime        @default(now())
  owner          RestaurantOwner @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("restaurant_owner_sessions")
}

model SubscriptionPlan {
  id                 String         @id @default(uuid())
  name               String         @unique
  monthlyFee         Decimal        @db.Decimal(10, 2)
  transactionFeeRate Decimal        @db.Decimal(5, 4)
  maxTables          Int?
  maxStaff           Int?
  features           Json           @default("{}")
  isActive           Boolean        @default(true)
  sortOrder          Int            @default(0)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  subscriptions      Subscription[]

  @@map("subscription_plans")
}

model Subscription {
  id                   String           @id @default(uuid())
  restaurantId         String           @unique
  planId               String
  stripeSubscriptionId String?          @unique
  stripeCustomerId     String?
  status               String           @default("active")
  billingCycle         String           @default("monthly")
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  cancelAtPeriodEnd    Boolean          @default(false)
  canceledAt           DateTime?
  trialStart           DateTime?
  trialEnd             DateTime?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  invoices             Invoice[]
  plan                 SubscriptionPlan @relation(fields: [planId], references: [id])
  restaurant           Restaurant       @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  transactionFees      TransactionFee[]

  @@index([restaurantId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model Restaurant {
  id                      String               @id @default(uuid())
  ownerId                 String
  name                    String
  slug                    String               @unique
  address                 String
  phone                   String?
  email                   String?
  timezone                String               @default("UTC")
  currency                String               @default("USD")
  taxRate                 Decimal              @default(0.0000) @db.Decimal(5, 4)
  serviceChargeRate       Decimal              @default(0.0000) @db.Decimal(5, 4)
  isActive                Boolean              @default(true)
  brandingConfig          Json                 @default("{}")
  businessType            String               @default("restaurant")
  maxTables               Int                  @default(50)
  maxStaff                Int                  @default(20)
  description             String?
  website                 String?
  logoUrl                 String?
  coverImageUrl           String?
  galleryImages           Json                 @default("[]")
  socialMedia             Json                 @default("{}")
  operatingHours          Json                 @default("{}")
  features                Json                 @default("[]")
  cuisineTypes            Json                 @default("[]")
  priceRange              String               @default("$$")
  showOnDirectory         Boolean              @default(true)
  acceptsReservations     Boolean              @default(false)
  maxReservationDays      Int                  @default(30)
  reservationTimeSlots    Int                  @default(60)
  autoConfirmReservations Boolean              @default(false)
  deliveryAvailable       Boolean              @default(false)
  takeoutAvailable        Boolean              @default(true)
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  notificationSettings    Json                 @default("{\"soundType\": \"chime\", \"orderAlerts\": true, \"soundEnabled\": true, \"desktopNotifications\": true}")
  paymentMethods          Json                 @default("{\"card\": true, \"cash\": true, \"ewallet\": true}")
  receiptSettings         Json                 @default("{\"paperSize\": \"80mm\", \"footerText\": \"Please come again!\", \"headerText\": \"Thank you for dining with us!\"}")
  serviceChargeLabel      String               @default("Service Charge (10%)")
  systemPreferences       Json                 @default("{\"dateFormat\": \"DD/MM/YYYY\", \"timeFormat\": \"24h\", \"numberFormat\": \"1,234.56\"}")
  taxLabel                String               @default("SST (6%)")
  categories              MenuCategory[]
  menuItems               MenuItem[]
  orders                  Order[]
  pushSubscriptions       PushSubscription[]
  reservations            Reservation[]
  owner                   RestaurantOwner      @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  staff                   Staff[]
  roleHierarchy           StaffRoleHierarchy[]
  subscription            Subscription?
  tables                  Table[]
  transactionFees         TransactionFee[]
  userRoles               UserRole[]
  userSessions            UserSession[]

  @@index([ownerId])
  @@index([slug])
  @@map("restaurants")
}

model Table {
  id                  String            @id @default(uuid())
  restaurantId        String
  tableNumber         String
  tableName           String?
  qrCodeToken         String            @unique
  capacity            Int               @default(4)
  locationDescription String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  status              TableStatus       @default(AVAILABLE)
  customerSessions    CustomerSession[]
  orders              Order[]
  reservations        Reservation[]
  restaurant          Restaurant        @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, tableNumber])
  @@map("tables")
}

model MenuCategory {
  id           String     @id @default(uuid())
  restaurantId String
  name         String
  description  String?
  displayOrder Int        @default(0)
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  menuItems    MenuItem[]

  @@index([restaurantId])
  @@index([isActive])
  @@map("menu_categories")
}

model MenuItem {
  id                String                  @id @default(uuid())
  restaurantId      String
  categoryId        String
  name              String
  description       String?
  price             Decimal                 @db.Decimal(10, 2)
  costPrice         Decimal?                @db.Decimal(10, 2)
  imageUrl          String?
  preparationTime   Int                     @default(0)
  calories          Int?
  allergens         String[]
  dietaryInfo       String[]
  isAvailable       Boolean                 @default(true)
  isFeatured        Boolean                 @default(false)
  displayOrder      Int                     @default(0)
  createdAt         DateTime                @default(now())
  updatedAt         DateTime                @updatedAt
  cartItems         CartItem[]
  variations        MenuItemVariation[]
  category          MenuCategory            @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  restaurant        Restaurant              @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  orderItems        OrderItem[]
  modificationItems OrderModificationItem[]

  @@index([restaurantId])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([isFeatured])
  @@map("menu_items")
}

model MenuItemVariation {
  id                  String               @id @default(uuid())
  menuItemId          String
  name                String
  priceModifier       Decimal              @default(0.00) @db.Decimal(10, 2)
  variationType       String
  isRequired          Boolean              @default(false)
  maxSelections       Int                  @default(1)
  displayOrder        Int                  @default(0)
  createdAt           DateTime             @default(now())
  cartItems           CartItem[]
  menuItem            MenuItem             @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  orderItemVariations OrderItemVariation[]

  @@index([menuItemId])
  @@index([variationType])
  @@map("menu_item_variations")
}

model TransactionFee {
  id               String       @id @default(uuid())
  restaurantId     String
  orderId          String       @unique
  subscriptionId   String
  orderAmount      Decimal      @db.Decimal(10, 2)
  feeRate          Decimal      @db.Decimal(5, 4)
  feeAmount        Decimal      @db.Decimal(10, 2)
  stripeFee        Decimal      @default(0.00) @db.Decimal(10, 2)
  netFee           Decimal      @db.Decimal(10, 2)
  currency         String       @default("USD")
  processedAt      DateTime     @default(now())
  payoutStatus     String       @default("pending")
  payoutDate       DateTime?
  stripeTransferId String?
  createdAt        DateTime     @default(now())
  order            Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  restaurant       Restaurant   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  subscription     Subscription @relation(fields: [subscriptionId], references: [id])

  @@index([restaurantId])
  @@index([orderId])
  @@index([processedAt])
  @@index([payoutStatus])
  @@map("transaction_fees")
}

model Invoice {
  id               String        @id @default(uuid())
  subscriptionId   String
  stripeInvoiceId  String?       @unique
  invoiceNumber    String        @unique
  status           String        @default("draft")
  currency         String        @default("USD")
  subtotal         Decimal       @db.Decimal(10, 2)
  taxAmount        Decimal       @default(0.00) @db.Decimal(10, 2)
  totalAmount      Decimal       @db.Decimal(10, 2)
  amountPaid       Decimal       @default(0.00) @db.Decimal(10, 2)
  amountDue        Decimal       @db.Decimal(10, 2)
  periodStart      DateTime
  periodEnd        DateTime
  dueDate          DateTime?
  paidAt           DateTime?
  hostedInvoiceUrl String?
  invoicePdf       String?
  paymentIntentId  String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  items            InvoiceItem[]
  subscription     Subscription  @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
  @@index([status])
  @@map("invoices")
}

model InvoiceItem {
  id          String    @id @default(uuid())
  invoiceId   String
  description String
  quantity    Int       @default(1)
  unitAmount  Decimal   @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  currency    String    @default("USD")
  itemType    String
  periodStart DateTime?
  periodEnd   DateTime?
  createdAt   DateTime  @default(now())
  invoice     Invoice   @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId])
  @@map("invoice_items")
}

model StaffRole {
  id           String               @id @default(uuid())
  name         String               @unique
  description  String?
  permissions  Json                 @default("{}")
  isSystemRole Boolean              @default(false)
  level        Int                  @default(1)
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  staff        Staff[]
  hierarchy    StaffRoleHierarchy[]

  @@map("staff_roles")
}

model StaffRoleHierarchy {
  id           String               @id @default(uuid())
  restaurantId String
  roleId       String
  parentId     String?
  maxCount     Int?
  isActive     Boolean              @default(true)
  createdAt    DateTime             @default(now())
  parent       StaffRoleHierarchy?  @relation("HierarchyTree", fields: [parentId], references: [id])
  children     StaffRoleHierarchy[] @relation("HierarchyTree")
  restaurant   Restaurant           @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  role         StaffRole            @relation(fields: [roleId], references: [id])

  @@unique([restaurantId, roleId])
  @@index([restaurantId])
  @@index([parentId])
  @@map("staff_role_hierarchy")
}

model Staff {
  id                     String         @id @default(uuid())
  restaurantId           String
  roleId                 String
  email                  String         @unique
  username               String         @unique
  passwordHash           String
  firstName              String
  lastName               String
  phone                  String?
  employeeId             String?
  hireDate               DateTime?
  hourlyRate             Decimal?       @db.Decimal(8, 2)
  isActive               Boolean        @default(true)
  lastLoginAt            DateTime?
  passwordChangedAt      DateTime       @default(now())
  mustChangePassword     Boolean        @default(false)
  failedLoginAttempts    Int            @default(0)
  lockedUntil            DateTime?
  permissions            Json           @default("{}")
  emailVerified          Boolean        @default(false)
  emailVerificationToken String?
  passwordResetToken     String?
  passwordResetExpires   DateTime?
  twoFactorEnabled       Boolean        @default(false)
  twoFactorSecret        String?
  backupCodes            String[]       @default([])
  createdAt              DateTime       @default(now())
  updatedAt              DateTime       @updatedAt
  auditLogs              AuditLog[]     @relation("StaffAuditLogs")
  orders                 Order[]
  payments               Payment[]
  refreshTokens          RefreshToken[]
  restaurant             Restaurant     @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  role                   StaffRole      @relation(fields: [roleId], references: [id])
  sessions               StaffSession[]

  @@index([restaurantId])
  @@index([roleId])
  @@index([email])
  @@map("staff")
}

model StaffSession {
  id             String   @id @default(uuid())
  staffId        String
  sessionToken   String   @unique
  ipAddress      String?
  userAgent      String?
  expiresAt      DateTime
  createdAt      DateTime @default(now())
  lastActivityAt DateTime @default(now())
  staff          Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@map("staff_sessions")
}

model CustomerSession {
  id            String                @id @default(uuid())
  tableId       String
  sessionToken  String                @unique
  customerName  String?
  customerPhone String?
  customerEmail String?
  ipAddress     String?
  userAgent     String?
  startedAt     DateTime              @default(now())
  expiresAt     DateTime
  endedAt       DateTime?
  status        CustomerSessionStatus @default(ACTIVE)
  cartItems     CartItem[]
  table         Table                 @relation(fields: [tableId], references: [id], onDelete: Cascade)
  orders        Order[]

  @@index([tableId])
  @@index([status])
  @@index([tableId, status])
  @@map("customer_sessions")
}

model CartItem {
  id                  String             @id @default(uuid())
  customerSessionId   String
  menuItemId          String
  variationId         String?
  quantity            Int                @default(1)
  unitPrice           Decimal            @db.Decimal(10, 2)
  subtotal            Decimal            @db.Decimal(10, 2)
  specialInstructions String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  customerSession     CustomerSession    @relation(fields: [customerSessionId], references: [id], onDelete: Cascade)
  menuItem            MenuItem           @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  variation           MenuItemVariation? @relation(fields: [variationId], references: [id])

  @@index([customerSessionId])
  @@index([menuItemId])
  @@map("cart_items")
}

model Order {
  id                  String              @id @default(uuid())
  orderNumber         String              @unique
  restaurantId        String
  tableId             String
  customerSessionId   String
  subtotalAmount      Decimal             @default(0.00) @db.Decimal(10, 2)
  taxAmount           Decimal             @default(0.00) @db.Decimal(10, 2)
  serviceCharge       Decimal             @default(0.00) @db.Decimal(10, 2)
  discountAmount      Decimal             @default(0.00) @db.Decimal(10, 2)
  totalAmount         Decimal             @default(0.00) @db.Decimal(10, 2)
  takenBy             String?
  confirmedBy         String?
  servedBy            String?
  specialInstructions String?
  estimatedReadyTime  DateTime?
  createdAt           DateTime            @default(now())
  confirmedAt         DateTime?
  readyAt             DateTime?
  servedAt            DateTime?
  updatedAt           DateTime            @updatedAt
  hasModifications    Boolean             @default(false)
  lastModifiedAt      DateTime?
  modificationCount   Int                 @default(0)
  version             Int                 @default(1)
  status              OrderStatus         @default(PENDING)
  paymentStatus       OrderPaymentStatus  @default(PENDING)
  items               OrderItem[]
  modifications       OrderModification[]
  customerSession     CustomerSession     @relation(fields: [customerSessionId], references: [id], onDelete: Cascade)
  restaurant          Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table               Table               @relation(fields: [tableId], references: [id], onDelete: Cascade)
  takenByStaff        Staff?              @relation(fields: [takenBy], references: [id])
  paymentIntents      PaymentIntent[]
  payments            Payment[]
  transactionFee      TransactionFee?

  @@index([restaurantId])
  @@index([tableId])
  @@index([status])
  @@index([paymentStatus])
  @@index([createdAt])
  @@index([hasModifications])
  @@index([version])
  @@map("orders")
}

model OrderItem {
  id                  String                  @id @default(uuid())
  orderId             String
  menuItemId          String
  quantity            Int
  unitPrice           Decimal                 @db.Decimal(10, 2)
  totalAmount         Decimal                 @db.Decimal(10, 2)
  specialInstructions String?
  createdAt           DateTime                @default(now())
  updatedAt           DateTime                @updatedAt
  status              OrderItemStatus         @default(PENDING)
  variations          OrderItemVariation[]
  menuItem            MenuItem                @relation(fields: [menuItemId], references: [id], onDelete: Cascade)
  order               Order                   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  modificationItems   OrderModificationItem[]

  @@index([orderId])
  @@index([menuItemId])
  @@index([status])
  @@map("order_items")
}

model OrderItemVariation {
  id          String            @id @default(uuid())
  orderItemId String
  variationId String
  quantity    Int               @default(1)
  unitPrice   Decimal           @db.Decimal(10, 2)
  totalAmount Decimal           @db.Decimal(10, 2)
  createdAt   DateTime          @default(now())
  orderItem   OrderItem         @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  variation   MenuItemVariation @relation(fields: [variationId], references: [id], onDelete: Cascade)

  @@map("order_item_variations")
}

model PaymentIntent {
  id              String    @id @default(uuid())
  orderId         String
  amount          Decimal   @db.Decimal(10, 2)
  currency        String    @default("MYR")
  paymentMethodId String
  status          String    @default("pending")
  reference       String    @unique
  transactionId   String?
  metadata        Json      @default("{}")
  expiresAt       DateTime
  createdAt       DateTime  @default(now())
  confirmedAt     DateTime?
  updatedAt       DateTime  @updatedAt
  referenceNumber String?
  verifiedAt      DateTime?
  verifiedBy      String?
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("payment_intents")
}

model Payment {
  id                    String             @id @default(uuid())
  orderId               String
  paymentMethod         String
  paymentProcessor      String?
  amount                Decimal            @db.Decimal(10, 2)
  processingFee         Decimal            @default(0.00) @db.Decimal(10, 2)
  netAmount             Decimal            @db.Decimal(10, 2)
  externalPaymentId     String?
  externalTransactionId String?
  paymentMetadata       Json               @default("{}")
  failureReason         String?
  refundReason          String?
  createdAt             DateTime           @default(now())
  processedAt           DateTime?
  completedAt           DateTime?
  failedAt              DateTime?
  updatedAt             DateTime           @updatedAt
  cashReceived          Decimal?           @db.Decimal(10, 2)
  changeGiven           Decimal?           @db.Decimal(10, 2)
  processedBy           String?
  processedByAdminId    String?
  processedByOwnerId    String?
  processedByStaffId    String?
  processedByType       String?
  receiptNumber         String?            @unique
  status                OrderPaymentStatus @default(PENDING)
  order                 Order              @relation(fields: [orderId], references: [id], onDelete: Cascade)
  processedByAdmin      PlatformAdmin?     @relation(fields: [processedByAdminId], references: [id])
  processedByOwner      RestaurantOwner?   @relation(fields: [processedByOwnerId], references: [id])
  processedByStaff      Staff?             @relation(fields: [processedByStaffId], references: [id])

  @@index([processedBy])
  @@index([processedByType])
  @@index([processedByAdminId])
  @@index([processedByOwnerId])
  @@index([processedByStaffId])
  @@index([receiptNumber])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

model SecurityEvent {
  id                String    @id @default(uuid())
  eventType         String
  severity          String
  tableId           String?
  staffId           String?
  customerSessionId String?
  orderId           String?
  ipAddress         String?
  userAgent         String?
  requestPath       String?
  requestMethod     String?
  eventData         Json      @default("{}")
  description       String?
  resolved          Boolean   @default(false)
  resolvedBy        String?
  resolvedAt        DateTime?
  resolutionNotes   String?
  createdAt         DateTime  @default(now())

  @@map("security_events")
}

model AuditLog {
  id            String           @id @default(uuid())
  tableName     String
  recordId      String
  operation     String
  oldValues     Json?
  newValues     Json?
  changedBy     String?
  changedByType String?
  restaurantId  String?
  adminId       String?
  ownerId       String?
  staffId       String?
  severity      String           @default("info")
  category      String           @default("general")
  description   String?
  metadata      Json             @default("{}")
  changedAt     DateTime         @default(now())
  ipAddress     String?
  userAgent     String?
  sessionId     String?
  admin         PlatformAdmin?   @relation("AdminAuditLogs", fields: [adminId], references: [id])
  owner         RestaurantOwner? @relation("OwnerAuditLogs", fields: [ownerId], references: [id])
  staff         Staff?           @relation("StaffAuditLogs", fields: [staffId], references: [id])

  @@index([tableName])
  @@index([recordId])
  @@index([operation])
  @@index([changedBy])
  @@index([changedByType])
  @@index([restaurantId])
  @@index([severity])
  @@index([category])
  @@index([changedAt])
  @@map("audit_logs")
}

model Notification {
  id           String    @id @default(uuid())
  userId       String
  userType     String
  restaurantId String?
  title        String
  message      String
  type         String    @default("info")
  isRead       Boolean   @default(false)
  readAt       DateTime?
  metadata     Json      @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([userId])
  @@index([userType])
  @@index([restaurantId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

model Reservation {
  id               String     @id @default(uuid())
  restaurantId     String
  tableId          String?
  customerName     String
  customerEmail    String
  customerPhone    String?
  partySize        Int
  reservationDate  DateTime
  status           String     @default("pending")
  specialRequests  String?
  confirmationCode String     @unique
  notes            String?
  confirmedAt      DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt
  restaurant       Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  table            Table?     @relation(fields: [tableId], references: [id])

  @@index([restaurantId])
  @@index([tableId])
  @@index([reservationDate])
  @@index([status])
  @@index([confirmationCode])
  @@map("reservations")
}

model UserRole {
  id                String        @id @default(uuid())
  userId            String
  userType          String
  restaurantId      String?
  roleTemplate      String
  customPermissions Json          @default("[]")
  isActive          Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  restaurant        Restaurant?   @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  userSessions      UserSession[]

  @@index([userId])
  @@index([userType])
  @@index([restaurantId])
  @@index([roleTemplate])
  @@index([isActive])
  @@map("user_roles")
}

model Permission {
  id              String           @id @default(uuid())
  permissionKey   String           @unique
  description     String
  category        String
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  rolePermissions RolePermission[]

  @@index([permissionKey])
  @@index([category])
  @@index([isActive])
  @@map("permissions")
}

model RolePermission {
  id            String     @id @default(uuid())
  roleTemplate  String
  permissionKey String
  grantedAt     DateTime   @default(now())
  permission    Permission @relation(fields: [permissionKey], references: [permissionKey], onDelete: Cascade)

  @@unique([roleTemplate, permissionKey])
  @@index([roleTemplate])
  @@index([permissionKey])
  @@map("role_permissions")
}

model UserSession {
  id                  String      @id @default(uuid())
  userId              String
  sessionId           String      @unique
  currentRoleId       String
  restaurantContextId String?
  jwtTokenHash        String?
  permissions         Json        @default("[]")
  expiresAt           DateTime
  lastActivity        DateTime    @default(now())
  ipAddress           String?
  userAgent           String?
  createdAt           DateTime    @default(now())
  currentRole         UserRole    @relation(fields: [currentRoleId], references: [id], onDelete: Cascade)
  restaurantContext   Restaurant? @relation(fields: [restaurantContextId], references: [id])

  @@index([userId])
  @@index([sessionId])
  @@index([currentRoleId])
  @@index([restaurantContextId])
  @@index([expiresAt])
  @@map("user_sessions")
}

model RefreshToken {
  id            String           @id @default(uuid())
  token         String           @unique
  userId        String
  userType      String
  sessionId     String
  adminId       String?
  ownerId       String?
  staffId       String?
  expiresAt     DateTime
  lastUsed      DateTime         @default(now())
  ipAddress     String?
  userAgent     String?
  deviceInfo    Json             @default("{}")
  isRevoked     Boolean          @default(false)
  revokedAt     DateTime?
  revokedReason String?
  createdAt     DateTime         @default(now())
  admin         PlatformAdmin?   @relation(fields: [adminId], references: [id], onDelete: Cascade)
  owner         RestaurantOwner? @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  staff         Staff?           @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@index([userType])
  @@index([sessionId])
  @@index([adminId])
  @@index([ownerId])
  @@index([staffId])
  @@index([expiresAt])
  @@index([isRevoked])
  @@map("refresh_tokens")
}

model RBACLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  resource  String?
  fromRole  String?
  toRole    String?
  metadata  Json     @default("{}")
  ipAddress String?
  userAgent String?
  sessionId String?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([resource])
  @@index([sessionId])
  @@index([createdAt])
  @@map("rbac_logs")
}

model CacheEntry {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([expiresAt])
  @@index([key, expiresAt])
  @@map("cache_entries")
}

model SystemConfig {
  id          String   @id @default(uuid())
  key         String   @unique
  value       String
  iv          String
  tag         String
  description String?
  updatedBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([key])
  @@map("system_config")
}

model PendingEvent {
  id           String    @id @default(uuid())
  eventType    String    @db.VarChar(50)
  eventData    Json
  restaurantId String    @db.Uuid
  createdAt    DateTime  @default(now())
  deliveredAt  DateTime?

  @@index([restaurantId, createdAt], map: "idx_restaurant_pending")
  @@index([createdAt], map: "idx_cleanup")
  @@map("pending_events")
}

model OrderModification {
  id               String                  @id @default(uuid())
  orderId          String
  modifiedBy       String?
  modifiedAt       DateTime                @default(now())
  reason           String
  reasonNotes      String?
  oldTotal         Decimal                 @db.Decimal(10, 2)
  newTotal         Decimal                 @db.Decimal(10, 2)
  customerNotified Boolean                 @default(false)
  notifiedAt       DateTime?
  idempotencyKey   String                  @unique
  createdAt        DateTime                @default(now())
  items            OrderModificationItem[]
  order            Order                   @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([modifiedAt])
  @@index([idempotencyKey])
  @@map("order_modifications")
}

model OrderModificationItem {
  id             String            @id @default(uuid())
  modificationId String
  orderItemId    String?
  menuItemId     String
  action         String
  oldQuantity    Int?
  newQuantity    Int?
  oldPrice       Decimal?          @db.Decimal(10, 2)
  newPrice       Decimal?          @db.Decimal(10, 2)
  createdAt      DateTime          @default(now())
  menuItem       MenuItem          @relation(fields: [menuItemId], references: [id])
  modification   OrderModification @relation(fields: [modificationId], references: [id], onDelete: Cascade)
  orderItem      OrderItem?        @relation(fields: [orderItemId], references: [id])

  @@index([modificationId])
  @@index([orderItemId])
  @@map("order_modification_items")
}

model PushSubscription {
  id           String     @id @default(uuid())
  userId       String
  userType     String
  restaurantId String
  endpoint     String     @unique
  p256dh       String
  auth         String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  restaurant   Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@index([userId, userType])
  @@index([restaurantId])
  @@index([endpoint])
  @@map("push_subscriptions")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  READY
  SERVED
  CANCELLED
}

enum OrderPaymentStatus {
  PENDING
  PAID
  REFUNDED
  FAILED
}

enum TableStatus {
  AVAILABLE
  OCCUPIED
  RESERVED
}

enum CustomerSessionStatus {
  ACTIVE
  ENDED
  EXPIRED
}

enum OrderItemStatus {
  PENDING
  PREPARING
  READY
  SERVED
  CANCELLED
}
